class Mutator
  PHONE_TEXT = "\n\nüöÄ –í –Ω–∞–ª–∏—á–∏–∏ –∏ –ø–æ–¥ –∑–∞–∫–∞–∑, –æ–ø—Ç–æ–º –∏ –≤ —Ä–æ–∑–Ω–∏—Ü—É, –æ—Ç–ø—Ä–∞–≤–∏–º –ª—é–±–æ–π —Ç–∫ –ø–æ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ –∏–ª–∏ —á–µ—Ä–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∞ –ê–≤–∏—Ç–æ. –°–∫–ª–∞–¥—ã –≤ –ú–æ—Å–∫–≤–µ, –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ –∏ –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–µ.  –¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏ 8-913-590-4-777 –§—ë–¥–æ—Ä."

  PROMO_PATTERNS = [
    "–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ! ‚ö°Ô∏è\n–í –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2\n–ö—É—Ç—É–∑–æ–≤–∞ 1—Å—Ç—Ä105",
    "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–≥—Ä—É–∑–æ–º –ø–æ –≤—Å–µ–º –≥–æ—Ä–æ–¥–∞–º –æ—Ç –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∞ –¥–æ –û–º—Å–∫–∞ –ë–ï–°–ü–õ–ê–¢–ù–û!",
    "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ –ß–∏—Ç—ã –º–∞—à–∏–Ω–∞ –ë–ï–°–ü–õ–ê–¢–ù–û!",
    "–ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç–∞ 10 % –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞.",
    "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –†–§!",
    "üì≤–î–ª—è –∑–∞–∫–∞–∑–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: +79854485447",
    "–í –Ω–∞–ª–∏—á–∏–∏ –≤ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ",
    "–í –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2",
    "–ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2",
    "–ö—É—Ç—É–∑–æ–≤–∞ 1—Å—Ç—Ä105",
    "—É–ª. –ö—É—Ç—É–∑–æ–≤–∞, 1 —Å—Ç—Ä. 105.",
    "89955775669",
    "–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!",
    "üí¨ –ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!",
    "üí¨ **–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!**",
    "**–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!**",
    "üí¨ –ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!",
    "–í –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2",
    "‚ö°",
    "–ù–∞—à –∞–¥—Ä–µ—Å –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "****+79955775669****",
    "****+79697776163**",
    "üìç–ú–æ—Å–∫–≤–∞, —É–ª. –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "+7 (985) 773-53-23",
    "+7 (915) 266-08-68",
    "‚è∞–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:",
    "–ü–Ω-–ü—Ç: 10:00‚Äì18:00",
    "–°–±-–í—Å: 10:00‚Äì15:00",
    "üì©–ü–∏—à–∏—Ç–µ",
    "–í –Ω–∞–ª–∏—á–∏–∏:",
    "–õ–µ–≤—ã–π –±–µ—Ä–µ–≥",
    "–ü—Ä–∞–≤—ã–π –±–µ—Ä–µ–≥",
    "—É–ª. –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ, 25",
    "–ö—É—Ç—É–∑–æ–≤–∞, 1, —Å—Ç—Ä. 105",
    "+7-995-577-56-69",
    "+7-969-777-61-63",
    "+79955775669",
    "+79697776163",
    "—É–ª. –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "üòä–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "üòä+7 (985) 773-53-23",
    "üòä+7 (915) 266-08-68",
    "‚è∞** –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:**  ",
    "üì≤–î–ª—è –∑–∞–∫–∞–∑–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: +79854485447",
    "–ê–¥—Ä–µ—Å: –≥. –ú–æ—Å–∫–≤–∞,",
    "–î–ª—è –∑–∞–∫–∞–∑–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ –Ω–æ–º–µ—Ä–∞–º:",
    "–ü–†–ê–ô–° –° –ê–ö–¢–£–ê–õ–¨–ù–´–ú–ò –¶–ï–ù–ê–ú–ò",
    "–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø—Ç–æ–≤–æ–≥–æ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ –∏ —É—Å–ª–æ–≤–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞:",
    "üí¨ **–ß–∞—Ç –í–∞—Ç—Å–∞–ø–ø**",
    "üí¨ **–ß–∞—Ç –¢–µ–ª–µ–≥—Ä–∞–º–º**",
    "üìß opt@china-line.org",
    "ü§çü§çü§ç",
    "–õ–µ–≤—ã–π –±–µ—Ä–µ–≥",
    "–ü—Ä–∞–≤—ã–π –±–µ—Ä–µ–≥",
    "‚¶Å —É–ª. –ö—É—Ç—É–∑–æ–≤–∞, 1 —Å—Ç—Ä. 105",
    "–ù–∞—à–∏ –∞–¥—Ä–µ—Å–∞ –≤ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ",
    "üòä–≥. –ú–æ—Å–∫–≤–∞,",
    "–ù–∞—à–∏ –∞–¥—Ä–µ—Å–∞",
    "–û–∂–∏–¥–∞–π—Ç–µ —É–∂–µ 10.04.24 –≤ –º–∞–≥–∞–∑–∏–Ω–µ-—Å–∫–ª–∞–¥–µ China-line –ø–æ –∞–¥—Ä–µ—Å—É .",
    "–î–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ –Ω–æ–º–µ—Ä–∞–º:",
    "+7 985 448 54 47",
    "+7 985 773 53 23",
    "****üìß**** ****opt@china-line.org**",
    "**–ü–æ—á—Ç–∞:** msk@china-line.org",
    "–ò–ª–∏ –ø–∏—à–∏—Ç–µ –Ω–∞ –ø–æ—á—Ç—É:",
    "msk@china-line.org",
    "–¢–µ–ª–µ—Ñ–æ–Ω—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ –∏ –≤–æ–ø—Ä–æ—Å–∞–º —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞:",
    "+79852129797",
    "+79581977565",
    "+79675558766",
    "–ü–æ , –ù–æ–≤–æ–ø–æ—Å–µ–ª—Å–∫–∞—è 11—Å",
    "+7 (909) 150-88-78",
    "–ü–æ –∑–∞–∫–∞–∑–∞–º –∏ –ª—é–±—ã–º –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–º –í–∞—Å –≤–æ–ø—Ä–æ—Å–∞–º, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ –Ω–æ–º–µ—Ä–∞–º",
    "‚û°Ô∏è **–ì–¥–µ –Ω–∞—Å –Ω–∞–π—Ç–∏:**",
    "–ø–≥—Ç. –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫, —É–ª. –°–µ–≤–µ—Ä–Ω–∞—è 52–ë",
    "üìû **–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:**",
    "‚¶Å +7 (914) 451-79-51",
    "‚¶Å +7 (928) 881-77-76",
    "+7-914-451-79-51",
    "+7-963-256-39-15",
    "–ù–∞—à–∏ –º–∞–≥–∞–∑–∏–Ω—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è:",
    "–ù–∞—à–∏ –º–∞–≥–∞–∑–∏–Ω—ã**:",
    "—Ç–µ–ª. 8-963-256-39-15",
    "—Ç–µ–ª. 8-995-577-56-69",
    "—Ç–µ–ª. ****8-969-777-61-63****",
    "—Ç–µ–ª. ****8-995-577-56-69****",
    "‚Ä¢ –£–ª. –ö—É—Ç—É–∑–æ–≤–∞, 1—Å105",
    "8-995-577-56-69",
    "—É–ª. –°–µ–≤–µ—Ä–Ω–∞—è 52–ë",
    "+7 (914) 451-79-51",
    "–ù–æ–≤–æ–ø–æ—Å–µ–ª—Å–∫–∞—è 11—Å5",
    "–ø`–æ –∞–¥—Ä–µ—Å—É: ",
    "üìç** –ê–¥—Ä–µ—Å–∞ –≤ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ:**",
    "‚Ä¢ –£–ª. –ö—É—Ç—É–∑–æ–≤–∞, 1—Å105",
    "–≥. –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫ :",
    "–£–ª.–ö—É—Ç—É–∑–æ–≤–∞, 1—Å105",
    "+7 (914) 451-79-51**",
    "+7 (914) 451-79-51",
    "–£–ª. –ö—É—Ç—É–∑–æ–≤–∞, 1 —Å—Ç. 105",
    "**opt@china-line.org",
    "opt@china-line.org",
    "–û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º:",
    "‚§µÔ∏è–û–±—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º:",
    "–ù–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤:",
    ", –ù–æ–≤–æ–ø–æ—Å—ë–ª–∫–æ–≤–∞—è 11—Å5.",
    "**–ö–æ–Ω—Ç–∞–∫—Ç—ã:**",
    "–Ω–∞ –ø–æ—á—Ç—É –∏–ª–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:",
    "+79940259324",
    "+79940259321",
    "+79940259326",
    "+79940259315**",
    "+79940259315",
    "+7 994 025-93-24",
    "–ü–ì–¢. –ó–ê–ë–ê–ô–ö–ê–õ–¨–°–ö ** ",
    "+7 994 025-93-21 ",
    "+7 994 025-93-26",
    "+7 994 025-93-15",
    "üìû +",
    "üìû \\+\\d",
    "–¢–µ–ª: \\+",
    "üìû \\*\\*\\+\\*\\*",
    "–ó–∞–∫–∞–∑ –ø–∏—à–∏—Ç–µ –Ω–∞ –≤–∞—Ü–∞–ø  +79245030501",
    "–ó–∞–∫–∞–∑ –ø–∏—à–∏—Ç–µ –Ω–∞ –≤–∞—Ü–∞–ø",
    "+79245030501",
    "89245030501
  ].sort_by { |pattern| -pattern.length }.freeze


  JUNK_LINES = [
    "**",
    " ",
    "  ",
    "   ",
    "    ",
    "+",
    "++",
    "+++",
    "++++",
    "*****",
    "****+****",
    "****+**",
    "‚è∞** :**",
    "üí¨ ! ‚ö°",
    "üí¨ **!** ‚ö°",
    "‚ö°",
    "ü§çü§çü§ç",
    "üìç",
    "üì©",
    "üì©–ü–∏—à–∏—Ç–µ",
    "–ò–ª–∏ –ø–∏—à–∏—Ç–µ –Ω–∞ –ø–æ—á—Ç—É:",
    "–¢–µ–ª–µ—Ñ–æ–Ω—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ –∏ –≤–æ–ø—Ä–æ—Å–∞–º —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞:",
    "–ü–æ—á—Ç–∞:",
    "**–ü–æ—á—Ç–∞:** msk@china-line.org",
    "msk@china-line.org",
    "opt@china-line.org",
    "****üìß**** ******",
    "/2",
    "‚ñ™Ô∏è",
    "‚ñ™Ô∏è**",
    "üìé`",
    "‚Ä¢  ()",
    "‚¶Å **/2**",
    "‚¶Å –¢–µ–ª.: +",
    "‚¶Å ****",
    "‚¶Å –¢–µ–ª.: +",
    "**:**",
    ":",
    "üìç /2 (üìû ****+****)",
    "üìç  (üìû ****+****)",
    "üî•!",
    "-  - ",
    "()",
    "üìç** :**  ",
    "‚¶Å /2",
    "‚¶Å\"",
    "**",
    "üì≤",
    "üìß",
    "–ö–æ–Ω—Ç–∞–∫—Ç—ã:",
    "`",
    "üìû+ ",
    "–Ω–∞ –ø–æ—á—Ç—É –∏–ª–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:",
    "üíå",
    "–ê–¥—Ä–µ—Å:",
    "üè†",
    "üìå",
    ", ",
    "‚û°Ô∏è **:**",
    "‚¶Å Email: ",
    "–ù–∞—à–∏ :",
    "-  ",
    "–¢–µ–ª: +",
    "‚û°Ô∏è –ù–∞—à –∞–¥—Ä–µ—Å:",
    "******",
    " .",
    "–ù–∞—à–∏",
    "üòä",
    "üòä+",
    "üòä+', ",
    "**–ö–æ–Ω—Ç–∞–∫—Ç—ã:**",
    "**–ñ–¥—ë–º –≤–∞—Å :**",
    "üìß **",
    "üìû :",
    "[",
    "‚¶Å +",
    "üìû **:**",
    "**:",
    "+**",
    "Ôí° !  ",
    "Ôí° ! ",
    "Ôí° !",
    "/2 ()",
    "‚Ä¢ /2 ()  ",
    "–ú–æ—Å–∫–≤–∞: ",
    "–ú–æ—Å–∫–≤–∞:",
    "–ü–≥—Ç.–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫:",
    "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫:",
    "–¢–∞–∫–∂–µ :",
    "üìç –ì–¥–µ –∫—É–ø–∏—Ç—å?",
    "üåâ –ö–†–ê–°–ù–û–Ø–†–°–ö ‚Äî /2",
    "üè° ",
    "üåâ –ö–†–ê–°–ù–û–Ø–†–°–ö",
    "üèô ",
    "üìû +",
    "üìû",
    "üìû **+**",
    "üìû **:**",
    "‚è∞ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:",
    "‚û°Ô∏è **:**",
    "**:"
  ].freeze

  COMMISSION_PATTERNS = [
    "–í–∞—à–∞ –∫–æ–º–∏—Å—Å–∏—è"
  ].map(&:downcase).freeze

  SIMILARITY_THRESHOLD = 0.75

  def initialize(message_item)
    @message = message_item
  end

  def run
    puts "[MUTATOR] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ID #{@message.id}..."

    begin
      #unless add_phone_number
      #  puts "[MUTATOR] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
      #  return false
      #end

      unless remove_promo_text
        puts "[MUTATOR] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"
        return false
      end

      puts "[MUTATOR] ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ"
      true
    rescue => e
      puts "[MUTATOR] ‚ùå –û—à–∏–±–∫–∞: #{e.message}"
      false
    end
  end

  private

  def add_phone_number
    #sleep 1
    @message.reload

    current_text = @message.processed_text.to_s
    phone_regex = Regexp.escape(PHONE_TEXT.strip)

    return true if current_text.match?(/#{phone_regex}/i)

    updated_text = current_text + "\n\n" + PHONE_TEXT.strip
    @message.update!(processed_text: updated_text)
    true
  end

  def remove_promo_text
    #sleep 1
    @message.reload

    cleaned = exact_remove(@message.processed_text)
    cleaned = fuzzy_remove(cleaned)
    cleaned = remove_link_lines(cleaned) # <-- –ù–æ–≤—ã–π —à–∞–≥: —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏
    cleaned = remove_commission_lines(cleaned) # <-- –ù–æ–≤—ã–π —à–∞–≥: —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å –∫–æ–º–∏—Å—Å–∏–µ–π
    cleaned = remove_junk_lines(cleaned) # <-- –ù–æ–≤—ã–π —à–∞–≥: —É–¥–∞–ª–µ–Ω–∏–µ –º—É—Å–æ—Ä–Ω—ã—Ö —Å—Ç—Ä–æ–∫
    cleaned = cleaned.gsub(/(\n\s*){2,}/, "\n\n")
    cleaned = cleaned.gsub(/^\s*?\n/m, "\n")
    cleaned = cleaned.gsub(/\A\n+|\n+\z/, '')

    @message.update!(processed_text: cleaned.strip)
    true
  end

  def exact_remove(text)
    # –°–Ω–∞—á–∞–ª–∞ —Å–∞–º—ã–µ –¥–ª–∏–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (—É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã)
    PROMO_PATTERNS.reduce(text) do |current_text, pattern|
      # –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞
      normalized_pattern = pattern.gsub(/[^\w–∞-—è—ë]/iu, ' ').gsub(/\s+/, ' ').strip

      next current_text if normalized_pattern.empty?

      # –°–æ–∑–¥–∞–µ–º regex, –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç —ç—Ç—É —Ñ—Ä–∞–∑—É —Å –ª—é–±—ã–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏/—Å–∏–º–≤–æ–ª–∞–º–∏ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏
      words = normalized_pattern.split.map { |word| Regexp.escape(word) }
      regex = Regexp.new("#{words.join(".*")}", Regexp::IGNORECASE)

      if current_text.match?(regex)
        puts "[MUTATOR] üßπ –¢–æ—á–Ω–æ —É–¥–∞–ª–µ–Ω–æ: '#{pattern}'"
        current_text.gsub(regex, '')
      else
        current_text
      end
    end
  end

  def fuzzy_remove(text)
    PROMO_PATTERNS.reduce(text) do |current_text, pattern|
      if similar?(current_text, pattern, threshold: SIMILARITY_THRESHOLD)
        current_text.gsub(/#{Regexp.escape(pattern)}/i, "")
      else
        current_text
      end
    end.strip
  end

  def similar?(text, pattern, threshold:)
    text_words = text.downcase.gsub(/[^\w\s]/, "").split
    pattern_words = pattern.downcase.gsub(/[^\w\s]/, "").split

    common_words = (text_words & pattern_words).size.to_f / pattern_words.size.to_f
    common_words >= threshold
  end

  # üÜó –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: —É–¥–∞–ª—è–µ—Ç —Ü–µ–ª—ã–µ —Å—Ç—Ä–æ–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Å—Å—ã–ª–∫–∏
  def remove_link_lines(text)
    lines = text.split("\n")
    filtered = lines.reject { |line| line =~ /(https?:\/\/|t\.me|wa\.me)/i }
    filtered.join("\n")
  end

  def remove_junk_lines(text)
    puts "[MUTATOR] üßπ –ß–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–Ω—ã—Ö —Å—Ç—Ä–æ–∫..."

    lines = text.split("\n")
    before_count = lines.size

    filtered = lines.reject do |line|
      line_normalized = line.strip

      # 1. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –º—É—Å–æ—Ä–∞
      next true if JUNK_LINES.include?(line_normalized)

      # 2. –°—Ç—Ä–æ–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã/—ç–º–æ–¥–∑–∏ –±–µ–∑ –±—É–∫–≤
      if line_normalized.match?(/\A[\p{Emoji}\p{P}\s\+]+\z/) && !line_normalized.match?(/[–∞-—èa-z]/i)
        puts "[MUTATOR] üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ (—Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã): '#{line_normalized}'"
        next true
      end

      # 3. –°—Ç—Ä–æ–∫–∏-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è –∏–ª–∏ —Ü–∏—Ñ—Ä—ã —Å —Å–∏–º–≤–æ–ª–∞–º–∏)
      if line_normalized.match?(/\A[\p{P}\d\s\/‚Äì]+\z/)
        puts "[MUTATOR] üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å): '#{line_normalized}'"
        next true
      end

      # 4. –ù–µ–ø–æ–ª–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (—ç–º–æ–¥–∑–∏ + –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è)
      if line_normalized.match?(/\A\p{Emoji}[\s\p{P}]+\z/)
        puts "[MUTATOR] üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ (–Ω–µ–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç): '#{line_normalized}'"
        next true
      end

      false
    end

    after_count = filtered.size

    if before_count > after_count
      removed_count = before_count - after_count
      puts "[MUTATOR] ‚ú® –£–¥–∞–ª–µ–Ω–æ #{removed_count} –º—É—Å–æ—Ä–Ω—ã—Ö —Å—Ç—Ä–æ–∫"
    else
      puts "[MUTATOR] üßº –ú—É—Å–æ—Ä–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    end

    filtered.join("\n")
  end

  def remove_commission_lines(text)
    puts "[MUTATOR] üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å –∫–æ–º–∏—Å—Å–∏–µ–π..."

    lines = text.split("\n")
    before_count = lines.size

    filtered = lines.reject do |line|
      line_normalized = line.downcase.strip
      COMMISSION_PATTERNS.any? { |pattern| line_normalized.include?(pattern) }
    end

    after_count = filtered.size

    if before_count > after_count
      removed_lines = lines - filtered
      puts "[MUTATOR] ‚ú® –£–¥–∞–ª–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ —Å –∫–æ–º–∏—Å—Å–∏–µ–π:"
      removed_lines.each { |l| puts "[MUTATOR] ‚ùå '#{l}'" }
    else
      puts "[MUTATOR] üßº –°—Ç—Ä–æ–∫–∏ —Å –∫–æ–º–∏—Å—Å–∏–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    end

    filtered.join("\n")
  end

end
