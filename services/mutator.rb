class Mutator
  PHONE_TEXT = "\n\n–ó–≤–æ–Ω–∏—Ç–µ 89509901103"

  PROMO_PATTERNS = [
    "–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ! ‚ö°Ô∏è\n–í –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2\n–ö—É—Ç—É–∑–æ–≤–∞ 1—Å—Ç—Ä105",
    "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–≥—Ä—É–∑–æ–º –ø–æ –≤—Å–µ–º –≥–æ—Ä–æ–¥–∞–º –æ—Ç –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∞ –¥–æ –û–º—Å–∫–∞ –ë–ï–°–ü–õ–ê–¢–ù–û!",
    "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ –ß–∏—Ç—ã –º–∞—à–∏–Ω–∞ –ë–ï–°–ü–õ–ê–¢–ù–û!",
    "–ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç–∞ 10 % –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞.",
    "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –†–§!",
    "üì≤–î–ª—è –∑–∞–∫–∞–∑–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: +79854485447",
    "–í –Ω–∞–ª–∏—á–∏–∏ –≤ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ",
    "–í –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2",
    "–ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2",
    "–ö—É—Ç—É–∑–æ–≤–∞ 1—Å—Ç—Ä105",
    "—É–ª. –ö—É—Ç—É–∑–æ–≤–∞, 1 —Å—Ç—Ä. 105.",
    "89955775669",
    "–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!",
    "üí¨ –ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!",
    "üí¨ **–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!**",
    "**–ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!**",
    "üí¨ –ü–∏—à–∏ –≤ –¥–∏—Ä–µ–∫—Ç ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!",
    "–í –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ 25/2",
    "‚ö°",
    "–ù–∞—à –∞–¥—Ä–µ—Å –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "****+79955775669****",
    "****+79697776163**",
    "üìç–ú–æ—Å–∫–≤–∞, —É–ª. –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "+7 (985) 773-53-23",
    "+7 (915) 266-08-68",
    "‚è∞–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:",
    "–ü–Ω-–ü—Ç: 10:00‚Äì18:00",
    "–°–±-–í—Å: 10:00‚Äì15:00",
    "üì©–ü–∏—à–∏—Ç–µ",
    "–í –Ω–∞–ª–∏—á–∏–∏:",
    "–õ–µ–≤—ã–π –±–µ—Ä–µ–≥",
    "–ü—Ä–∞–≤—ã–π –±–µ—Ä–µ–≥",
    "—É–ª. –ú–∞–ª–∏–Ω–æ–≤—Å–∫–æ–≥–æ, 25",
    "–ö—É—Ç—É–∑–æ–≤–∞, 1, —Å—Ç—Ä. 105",
    "+7-995-577-56-69",
    "+7-969-777-61-63",
    "+79955775669",
    "+79697776163",
    "—É–ª. –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "üòä–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ù–æ–≤–æ–ø–æ—Å–µ–ª–∫–æ–≤–∞—è 11—Å5",
    "üòä+7 (985) 773-53-23",
    "üòä+7 (915) 266-08-68",
    "‚è∞** –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:**  ",
    "üì≤–î–ª—è –∑–∞–∫–∞–∑–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º: +79854485447",
    "–ê–¥—Ä–µ—Å: –≥. –ú–æ—Å–∫–≤–∞,",
    "–î–ª—è –∑–∞–∫–∞–∑–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ –Ω–æ–º–µ—Ä–∞–º:",
    "–ü–†–ê–ô–° –° –ê–ö–¢–£–ê–õ–¨–ù–´–ú–ò –¶–ï–ù–ê–ú–ò",
    "–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø—Ç–æ–≤–æ–≥–æ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞ –∏ —É—Å–ª–æ–≤–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞:",
    "üí¨ **–ß–∞—Ç –í–∞—Ç—Å–∞–ø–ø**",
    "üí¨ **–ß–∞—Ç –¢–µ–ª–µ–≥—Ä–∞–º–º**",
    "üìß opt@china-line.org",
    "ü§çü§çü§ç",
    "–õ–µ–≤—ã–π –±–µ—Ä–µ–≥",
    "–ü—Ä–∞–≤—ã–π –±–µ—Ä–µ–≥",
    "‚¶Å —É–ª. –ö—É—Ç—É–∑–æ–≤–∞, 1 —Å—Ç—Ä. 105",
    "–ù–∞—à–∏ –∞–¥—Ä–µ—Å–∞ –≤ –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ",
    "üòä–≥. –ú–æ—Å–∫–≤–∞,",
    "–ù–∞—à–∏ –∞–¥—Ä–µ—Å–∞",
    "–û–∂–∏–¥–∞–π—Ç–µ —É–∂–µ 10.04.24 –≤ –º–∞–≥–∞–∑–∏–Ω–µ-—Å–∫–ª–∞–¥–µ China-line –ø–æ –∞–¥—Ä–µ—Å—É .",
    "–î–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –ø–æ –Ω–æ–º–µ—Ä–∞–º:",
    "+7 985 448 54 47",
    "+7 985 773 53 23",
    "****üìß**** ****opt@china-line.org**"

  ].sort_by { |pattern| -pattern.length }.freeze

  SIMILARITY_THRESHOLD = 0.75

  def initialize(message_item)
    @message = message_item
  end

  def run
    puts "[MUTATOR] –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ID #{@message.id}..."

    begin
      unless add_phone_number
        puts "[MUTATOR] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
        return false
      end

      unless remove_promo_text
        puts "[MUTATOR] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"
        return false
      end

      puts "[MUTATOR] ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ"
      true
    rescue => e
      puts "[MUTATOR] ‚ùå –û—à–∏–±–∫–∞: #{e.message}"
      false
    end
  end

  private

  def add_phone_number
    sleep 1
    @message.reload

    current_text = @message.processed_text.to_s
    phone_regex = Regexp.escape(PHONE_TEXT.strip)

    return true if current_text.match?(/#{phone_regex}/i)

    updated_text = current_text + "\n\n" + PHONE_TEXT.strip
    @message.update!(processed_text: updated_text)
    true
  end

  def remove_promo_text
    sleep 1
    @message.reload

    cleaned = exact_remove(@message.processed_text)
    cleaned = fuzzy_remove(cleaned)
    cleaned = remove_link_lines(cleaned) # <-- –ù–æ–≤—ã–π —à–∞–≥: —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏
    cleaned = cleaned.gsub(/(\n\s*){2,}/, "\n\n")
    cleaned = cleaned.gsub(/^\s*?\n/m, "\n")
    cleaned = cleaned.gsub(/\A\n+|\n+\z/, '')

    @message.update!(processed_text: cleaned.strip)
    true
  end

  def exact_remove(text)
    PROMO_PATTERNS.reduce(text) do |current_text, pattern|
      regex = Regexp.escape(pattern).gsub(/\s+/, "\\s+")
      current_text.gsub(/#{regex}/im, "")
    end
  end

  def fuzzy_remove(text)
    PROMO_PATTERNS.reduce(text) do |current_text, pattern|
      if similar?(current_text, pattern, threshold: SIMILARITY_THRESHOLD)
        current_text.gsub(/#{Regexp.escape(pattern)}/i, "")
      else
        current_text
      end
    end.strip
  end

  def similar?(text, pattern, threshold:)
    text_words = text.downcase.gsub(/[^\w\s]/, "").split
    pattern_words = pattern.downcase.gsub(/[^\w\s]/, "").split

    common_words = (text_words & pattern_words).size.to_f / pattern_words.size.to_f
    common_words >= threshold
  end

  # üÜó –ù–æ–≤—ã–π –º–µ—Ç–æ–¥: —É–¥–∞–ª—è–µ—Ç —Ü–µ–ª—ã–µ —Å—Ç—Ä–æ–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Å—Å—ã–ª–∫–∏
  def remove_link_lines(text)
    lines = text.split("\n")
    filtered = lines.reject { |line| line =~ /(https?:\/\/|t\.me|wa\.me)/i }
    filtered.join("\n")
  end
end
