# frozen_string_literal: true

class Mutator
  PHONE_TEXT = "\n\nĞ—Ğ²Ğ¾Ğ½Ğ¸Ñ‚Ğµ 89509901103"

  # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ñ… Ñ„Ñ€Ğ°Ğ·, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
  PROMO_PATTERNS = [
    "ĞŸĞ¸ÑˆĞ¸ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚ â€” ÑĞ´ĞµĞ»Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ! âš¡ï¸\nĞ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸ Ğ½Ğ° ĞœĞ°Ğ»Ğ¸Ğ½Ğ¾Ğ²ÑĞºĞ¾Ğ³Ğ¾ 25/2\nĞšÑƒÑ‚ÑƒĞ·Ğ¾Ğ²Ğ° 1ÑÑ‚Ñ€105",
    "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ´Ğ¾Ğ³Ñ€ÑƒĞ·Ğ¾Ğ¼ Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°Ğ¼ Ğ¾Ñ‚ Ğ—Ğ°Ğ±Ğ°Ğ¹ĞºĞ°Ğ»ÑŒÑĞºĞ° Ğ´Ğ¾ ĞĞ¼ÑĞºĞ° Ğ‘Ğ•Ğ¡ĞŸĞ›ĞĞ¢ĞĞ!",
    "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ´Ğ¾ Ğ§Ğ¸Ñ‚Ñ‹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ° Ğ‘Ğ•Ğ¡ĞŸĞ›ĞĞ¢ĞĞ!",
    "ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° 10 % Ğ¾Ñ‚ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°.",
    "Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ°Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ Ğ¤!",
    "ğŸ“²Ğ”Ğ»Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ° ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼: +79854485447",
    "Ğ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸ Ğ² ĞšÑ€Ğ°ÑĞ½Ğ¾ÑÑ€ÑĞºĞµ",
    "ĞœĞ°Ğ»Ğ¸Ğ½Ğ¾Ğ²ÑĞºĞ¾Ğ³Ğ¾ 25/2",
    "ĞšÑƒÑ‚ÑƒĞ·Ğ¾Ğ²Ğ° 1ÑÑ‚Ñ€105",
    "89955775669",
    "ĞŸĞ¸ÑˆĞ¸ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚ â€” ÑĞ´ĞµĞ»Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ!",
    "ğŸ’¬ ĞŸĞ¸ÑˆĞ¸ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚ â€” ÑĞ´ĞµĞ»Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ!",
    "âš¡",
    "ĞĞ°Ñˆ Ğ°Ğ´Ñ€ĞµÑ ĞĞ¾Ğ²Ğ¾Ğ¿Ğ¾ÑĞµĞ»ĞºĞ¾Ğ²Ğ°Ñ 11Ñ5",
    "****+79955775669****",
    "****+79697776163**",

    # ğŸ”¥ ĞĞ¾Ğ²Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ:
    "ğŸ“ĞœĞ¾ÑĞºĞ²Ğ°, ÑƒĞ». ĞĞ¾Ğ²Ğ¾Ğ¿Ğ¾ÑĞµĞ»ĞºĞ¾Ğ²Ğ°Ñ 11Ñ5",
    "+7 (985) 773-53-23",
    "+7 (915) 266-08-68",
    "â°Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:",
    "ĞŸĞ½-ĞŸÑ‚: 10:00â€“18:00",
    "Ğ¡Ğ±-Ğ’Ñ: 10:00â€“15:00",
    "ğŸ“©ĞŸĞ¸ÑˆĞ¸Ñ‚Ğµ",
    "Ğ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸:",
    "Ğ›ĞµĞ²Ñ‹Ğ¹ Ğ±ĞµÑ€ĞµĞ³",
    "ĞŸÑ€Ğ°Ğ²Ñ‹Ğ¹ Ğ±ĞµÑ€ĞµĞ³",
    "ÑƒĞ». ĞœĞ°Ğ»Ğ¸Ğ½Ğ¾Ğ²ÑĞºĞ¾Ğ³Ğ¾, 25",
    "ĞšÑƒÑ‚ÑƒĞ·Ğ¾Ğ²Ğ°, 1, ÑÑ‚Ñ€. 105",
    "+7-995-577-56-69",
    "+7-969-777-61-63",
    "+79955775669",
    "+79697776163",
    "ÑƒĞ». ĞĞ¾Ğ²Ğ¾Ğ¿Ğ¾ÑĞµĞ»ĞºĞ¾Ğ²Ğ°Ñ 11Ñ5",
    "ğŸ˜ŠĞ³. ĞœĞ¾ÑĞºĞ²Ğ°, ÑƒĞ». ĞĞ¾Ğ²Ğ¾Ğ¿Ğ¾ÑĞµĞ»ĞºĞ¾Ğ²Ğ°Ñ 11Ñ5",
    "ğŸ˜Š+7 (985) 773-53-23",
    "ğŸ˜Š+7 (915) 266-08-68",
    "â°** Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹:**  ",
    "ğŸ“²Ğ”Ğ»Ñ Ğ·Ğ°ĞºĞ°Ğ·Ğ° ÑĞ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ¼: +79854485447"
  ].freeze

  # ĞŸĞ¾Ñ€Ğ¾Ğ³ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸ Ğ´Ğ»Ñ fuzzy-ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ (Ğ¾Ñ‚ 0.0 Ğ´Ğ¾ 1.0)
  SIMILARITY_THRESHOLD = 0.85

  def initialize(message_item)
    @message = message_item
  end

  # ğŸ ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´: Ğ¸Ğ·Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
  # - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½
  # - Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğµ Ñ„Ñ€Ğ°Ğ·Ñ‹
  def run
    puts "[MUTATOR] ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ ID #{@message.id}..."

    begin
      unless add_phone_number
        puts "[MUTATOR] âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°"
        return false
      end

      unless remove_promo_text
        puts "[MUTATOR] âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ°"
        return false
      end

      puts "[MUTATOR] âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾"
      true
    rescue => e
      puts "[MUTATOR] âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: #{e.message}"
      false
    end
  end

  private

  # ğŸ“ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğº ĞºĞ¾Ğ½Ñ†Ñƒ Ñ‚ĞµĞºÑÑ‚Ğ°, ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚
  def add_phone_number
    sleep 1
    @message.reload

    current_text = @message.processed_text.to_s
    phone_regex = Regexp.escape(PHONE_TEXT.strip)

    return true if current_text.match?(/#{phone_regex}/i)

    updated_text = current_text + "\n\n" + PHONE_TEXT.strip
    @message.update!(processed_text: updated_text)
    true
  end

  # ğŸ§¹ Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğµ Ñ„Ñ€Ğ°Ğ·Ñ‹ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ°
  def remove_promo_text
    sleep 1
    @message.reload

    # Ğ¨Ğ°Ğ³ 1: Ğ¢Ğ¾Ñ‡Ğ½Ñ‹Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
    cleaned = exact_remove(@message.processed_text)

    # Ğ¨Ğ°Ğ³ 2: Fuzzy-ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
    cleaned = fuzzy_remove(cleaned)

    # Ğ¨Ğ°Ğ³ 3: Ğ§Ğ¸ÑÑ‚ĞºĞ° Ğ¿ÑƒÑÑ‚Ñ‹Ñ… ÑÑ‚Ñ€Ğ¾Ğº Ğ¸ Ğ»Ğ¸ÑˆĞ½Ğ¸Ñ… Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¾Ğ²
    cleaned = cleaned.gsub(/(\n\s*){2,}/, "\n\n") # Ğ±Ğ¾Ğ»ĞµĞµ 2 Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¾Ğ² â†’ Ğ¾Ğ´Ğ¸Ğ½
    cleaned = cleaned.gsub(/^\s*?\n/m, "\n")     # Ğ¿ÑƒÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ â†’ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ğ¾Ğ´Ğ½Ñƒ
    cleaned = cleaned.gsub(/\A\n+|\n+\z/, '')     # ÑƒĞ±Ñ€Ğ°Ñ‚ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ/ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹

    # Ğ¨Ğ°Ğ³ 4: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚
    @message.update!(processed_text: cleaned.strip)
    true
  end

  # ğŸ” Ğ¢Ğ¾Ñ‡Ğ½Ğ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ñ… Ñ„Ñ€Ğ°Ğ· Ñ Ğ³Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒÑ Ğº Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ°Ğ¼ ÑÑ‚Ñ€Ğ¾Ğº
  def exact_remove(text)
    PROMO_PATTERNS.reduce(text) do |current_text, pattern|
      regex = Regexp.escape(pattern).gsub(/\s+/, "\\s+")
      current_text.gsub(/#{regex}/im, "")
    end
  end

  # ğŸ” Fuzzy ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ: ĞµÑĞ»Ğ¸ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ Ğ½Ğ° Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ½ÑƒÑ Ñ„Ñ€Ğ°Ğ·Ñƒ, Ñ‚Ğ¾Ğ¶Ğµ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼
  def fuzzy_remove(text)
    PROMO_PATTERNS.reduce(text) do |current_text, pattern|
      if similar?(current_text, pattern, threshold: SIMILARITY_THRESHOLD)
        current_text.gsub(/#{Regexp.escape(pattern)}/i, "")
      else
        current_text
      end
    end.strip
  end

  # ğŸ§  ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸ Ğ´Ğ²ÑƒÑ… ÑÑ‚Ñ€Ğ¾Ğº (Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ñ… ÑĞ»Ğ¾Ğ²)
  def similar?(text, pattern, threshold:)
    text_words = text.downcase.gsub(/[^\w\s]/, "").split
    pattern_words = pattern.downcase.gsub(/[^\w\s]/, "").split

    common_words = (text_words & pattern_words).size.to_f / pattern_words.size.to_f
    common_words >= threshold
  end
end
